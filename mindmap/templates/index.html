{% load static %}
<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Mind Map</title>
    <script src="{% static 'jQuery_Connections_files/jquery-latest.min.js' %}"></script>
    <script src="{% static 'jQuery_Connections_files/jquery-ui.js' %}"></script>
    <script type="text/javascript" src="{% static 'jQuery_Connections_files/jquery-timing.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'jQuery_Connections_files/jquery.ui.touch-punch.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'jQuery_Connections_files/jquery.connections.js' %}"></script>

    <link rel="stylesheet" href="{% static 'style.css' %}">

    <script type="text/JavaScript">
    var ID = 1000000;
$(document).ready(function() {

    $(".draggable").draggable();
    {% for relation in relations %}
        $("#draggable{{ relation.parent }}, #draggable{{ relation.child }}").connections({'class': 'fast'});
        var record = $('<div>', {
            id: 'recordConnect',
            style: 'width: 0; height: 0;',
            from: {{ relation.parent }},
            to: {{ relation.child }}
        });
        record.appendTo('body');
    {% endfor %}
    $.repeat().add('connection').each($).connections('update').wait(10);


    $(document).on('dblclick', '.draggable', function () {
        const input = $('<input>', {
            type: 'text',
            val: $(this).text().trim()
        });

        $(this).html(input);
        input.focus();
    });

    $(document).on('blur', 'input', function () {
        const div = $(this).parent();
        div.html('<p>' + $(this).val() + '</p>');
    });


    // Handle right click events on each div
    $(document).on('contextmenu', '[id^="draggable"]', (function (event) {
        event.preventDefault();
        var options = '<button class="delete">Delete</button>' +
            '<button class="create">Create</button>';
        $(this).append(options);
        // Handle create button click
        $(this).find('.create').click(function () {
            ID++;
            const newDiv = $('<div>', {
                id: 'draggable' + ID,
                class: 'draggable ui-widget-content ui-draggable',
                style: 'position: absolute; line-height: 20px; padding: 5px;',
                html: '<p>Drag me around</p>'
            });
            newDiv.appendTo('body');
            newDiv.draggable();
            $(this).closest('.draggable').connections({to: newDiv, 'class': 'fast'});
            var record = $('<div>', {
                id: 'recordConnect',
                style: 'width: 0; height: 0;',
                from: $(this).closest('.draggable').attr('id').match(/\d+/),
                to: ID
            });
            record.appendTo('body');
            $.repeat().add('connection').each($).connections('update').wait(10);
        });
        $(this).find('.delete').click(function () {
                var temp = $(this).closest('.draggable');
            $('div[id="recordConnect"]').filter(function () {
                console.log($(this).attr('from'), temp.attr('id').match(/\d+/)[0]);
                return $(this).attr('from') === temp.attr('id').match(/\d+/)[0]
                    || $(this).attr('to') === temp.attr('id').match(/\d+/)[0];
            }).remove();
            $(this).closest('.draggable').remove();
            $(this).closest('.draggable').connections('remove');
        });
    }));


    $(document).on("click", (function (event) {
        if (!$(event.target).closest('.draggable').length) {
            $('.draggable button').remove();
        }
    }));


    $("#createDivButton").click(function() {
        ID++;
        const newDiv = $('<div>', {
            id: 'draggable' + ID,
            class: 'draggable ui-widget-content ui-draggable',
            style: 'position: absolute; line-height: 20px; padding: 5px;',
            html: '<p>Drag me around</p>'
        });
        newDiv.appendTo('body');
        newDiv.draggable();
    });


    $("#clearButton").click(function() {
        $("div[id=recordConnect]").remove();
        $('.draggable').remove();
        $('.draggable').connections('remove');
    });


    $("#saveButton").click(function() {
        var nodes = [];
        var records = [];
        $('.draggable').each(function() {
            nodes.push({
                id: $(this).attr('id').match(/\d+/)[0],
                positionx: $(this).position().left,
                positiony: $(this).position().top,
                content: $(this).text().trim()
            })
        });
        $('div[id="recordConnect"]').each(function() {
            records.push({
                from: $(this).attr("from"),
                to: $(this).attr("to")
            })
        });

        // Send a post request with the information
        $.ajax({
            type: "POST",
            url: "/api/save/",
            data: `{
                "nodes": ${JSON.stringify(nodes)},
                "relation": ${JSON.stringify(records)}
            }`,
            success: function (response) {
                console.log("data saved");
            }
        });
    });


    $("#resetButton").click(function() {
        $("div[id=recordConnect]").remove();
        $('.draggable').remove();
        $('.draggable').connections('remove');

        var elements = [
            {
                id: "draggable1000001",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 640px; top: 322px;",
                text: "Climate Change"
            },
            {
                id: "draggable1000002",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 881px; top: 322px;",
                text: "Causes"
            },
            {
                id: "draggable1000003",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 674px; top: 166px;",
                text: "Evidence"
            },
            {
                id: "draggable1000004",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 673px; top: 486px;",
                text: "Solutions"
            },
            {
                id: "draggable1000005",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 482px; top: 487px;",
                text: "further Research"
            },
            {
                id: "draggable1000006",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 610px; top: 581px;",
                text: "Change human behavior"
            },
            {
                id: "draggable1000007",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 592px; top: 668px;",
                text: "Reduce burning of fossil fuels"
            },
            {
                id: "draggable1000008",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 859px; top: 579px;",
                text: "Explore renewable energy sources"
            },
            {
                id: "draggable1000009",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 1012px; top: 255px;",
                text: "human activities"
            },
            {
                id: "draggable1000010",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 973px; top: 397px;",
                text: "Natural Environment changes"
            },
            {
                id: "draggable1000011",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 810px; top: 104px;",
                text: "Warming Oceans"
            },
            {
                id: "draggable1000012",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 606px; top: 30px;",
                text: "increase in extreme weather"
            },
            {
                id: "draggable1000013",
                class: "draggable ui-widget-content ui-draggable",
                style: "line-height: 20px; padding: 5px; position: absolute; left: 456px; top: 105px;",
                text: "melting glaciers"
            },
        ];
        elements.forEach(function(element) {
            var newDiv = $('<div>', {
                id: element.id,
                class: element.class,
                style: element.style,
                html: element.text,
            });
            newDiv.appendTo('body');
            newDiv.draggable();
        });


        var connections = [
            {from: "1000001", to: "1000002"},
            {from: "1000001", to: "1000003"},
            {from: "1000001", to: "1000004"},
            {from: "1000004", to: "1000005"},
            {from: "1000004", to: "1000006"},
            {from: "1000006", to: "1000007"},
            {from: "1000006", to: "1000008"},
            {from: "1000002", to: "1000009"},
            {from: "1000002", to: "1000010"},
            {from: "1000003", to: "1000011"},
            {from: "1000003", to: "1000012"},
            {from: "1000003", to: "1000013"},
        ];

        connections.forEach(function(connection) {
            var newDiv = $("<div>", {
                id: "recordConnect",
                style: "width: 0; height: 0;",
                from: connection.from,
                to: connection.to
            });
            newDiv.appendTo('body');
            newDiv.draggable();
        });

        connections.forEach(function(connection) {
            $(`#draggable${connection.to}, #draggable${connection.from}`).connections({'class': 'fast'});
        });
    });

});
    </script>


  </head>
  <body>
    <button id="createDivButton">new root</button>
    <button id="saveButton">save</button>
    <button id="clearButton">Clear All</button>
    <button id="resetButton">Template</button>
    <br style="clear: both;">
    {% for node in nodes %}
    <div id="draggable{{ node.num }}" class="draggable ui-widget-content ui-draggable"
         style="line-height: 20px; padding: 5px; position: absolute; left: {{ node.positionx }}px; top: {{ node.positiony }}px;">
      <p>{{ node.content }}</p>
    </div>
    {% endfor %}


</body>
</html>